<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PERSTAT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- ✅ PWA support -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <script src="{{ url_for('static', filename='register_sw.js') }}"></script>
  <meta name="theme-color" content="#000000">

  <style>
    .navbar-nav .nav-link {
      font-size: 1.25rem;
      font-weight: bold;
    }
    .navbar-brand {
      font-size: 1.5rem;
      font-weight: bold;
    }
  </style>
</head>

<body class="bg-dark text-white">
  <nav class="navbar navbar-expand bg-black">
    <div class="container-fluid">
      <a class="navbar-brand text-white" href="/">PERSTAT</a>
      <div class="navbar-nav d-flex flex-row flex-wrap w-100 align-items-center">
        {% if session.get('user_id') %}
          <a class="nav-link text-white" href="/submit">Submit PERSTAT</a>
          <a class="nav-link text-white" href="/roster">Roster</a>
          <a class="nav-link text-white" href="/messages">Notifications</a>
          <a class="nav-link text-white" href="/ai_summary">AI Summary</a>
          {% if session.get('is_admin') %}
            <a class="nav-link text-white" href="/admin/users">Admin Panel</a>
          {% endif %}
          <a class="nav-link text-white" href="/logout">Logout</a>

          <!-- ✅ Manual enable button for iOS/Safari reliability -->
          <button id="enablePush" class="btn btn-sm btn-primary ms-2">Enable Notifications</button>
        {% endif %}
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-info">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </div>

  <!-- ✅ Push subscription logic (safe for iOS; requires user tap) -->
  <script>
    // Helper: convert base64 (URL-safe) to Uint8Array for PushManager
    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    async function enableNotifications() {
      try {
        if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
          alert("Push not supported on this device/browser.");
          return;
        }

        const permission = await Notification.requestPermission();
        if (permission !== "granted") {
          alert("Notifications were blocked. Enable them in your browser settings.");
          return;
        }

        const reg = await navigator.serviceWorker.register("/service-worker.js");
        const sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array("{{ VAPID_PUBLIC_KEY }}")
        });

        await fetch("/subscribe", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(sub)
        });

        console.log("✅ Subscribed to push:", sub);
        alert("Notifications enabled!");
      } catch (err) {
        console.error("❌ Failed to enable notifications", err);
        alert("Could not enable notifications. Try again or check console.");
      }
    }

    // Wire up the button (user gesture required on iOS)
    const btn = document.getElementById("enablePush");
    if (btn) btn.addEventListener("click", enableNotifications);

    // Optional: register SW on load (don’t auto-ask permission)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/service-worker.js").then(() => {
        console.log("Service worker registered");
      }).catch(err => {
        console.error("SW registration failed", err);
      });
    }
  </script>

  <!-- Bootstrap JS (needed for accordion/dropdowns) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
          crossorigin="anonymous"></script>
</body>
</html>
